<!DOCTYPE html>
<html>
<head>
  <title>실시간 문서 협업 테스트</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .status {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    textarea {
      width: 100%;
      height: 250px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 10px;
      resize: vertical;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0069d9;
    }
    .log {
      border: 1px solid #ddd;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background-color: #f5f5f5;
      font-family: monospace;
      font-size: 12px;
    }
    .panels {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
    }
    .panel h3 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .active-users {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #e9f5ff;
      border-radius: 4px;
    }
    .user-info {
      padding: 5px 10px;
      border-radius: 15px;
      display: inline-block;
      margin-right: 5px;
      margin-bottom: 5px;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>실시간 문서 협업 테스트</h1>
    
    <div class="controls">
      <input type="text" id="docId" placeholder="문서 ID" value="test-doc-123">
      <input type="text" id="username" placeholder="사용자 이름" value="사용자">
      <select id="userColor">
        <option value="#e74c3c">빨강</option>
        <option value="#3498db">파랑</option>
        <option value="#2ecc71">초록</option>
        <option value="#9b59b6">보라</option>
        <option value="#f39c12">주황</option>
      </select>
      <button id="connectBtn">연결</button>
      <button id="disconnectBtn" disabled>연결 해제</button>
    </div>
    
    <div id="status" class="status disconnected">연결 상태: 연결 안됨</div>
    
    <div class="active-users" id="activeUsers">
      접속자: 없음
    </div>
    
    <div class="panels">
      <div class="panel">
        <h3>공동 편집 문서</h3>
        <textarea id="editor" disabled placeholder="연결 후 편집할 수 있습니다..."></textarea>
      </div>
    </div>
    
    <h3>이벤트 로그</h3>
    <div id="log" class="log"></div>
  </div>

  <script>
    // DOM 요소
    const statusElement = document.getElementById('status');
    const editorElement = document.getElementById('editor');
    const logElement = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const docIdInput = document.getElementById('docId');
    const usernameInput = document.getElementById('username');
    const userColorSelect = document.getElementById('userColor');
    const activeUsersElement = document.getElementById('activeUsers');
    
    // 전역 변수
    let ws = null;
    let connected = false;
    let lastCursorPosition = 0;
    let activeUsers = new Map(); // 사용자 ID -> {name, color} 매핑
    let isLocalUpdate = false; // 로컬 업데이트 플래그
    
    // 랜덤 색상 선택
    userColorSelect.selectedIndex = Math.floor(Math.random() * userColorSelect.options.length);
    
    // 로그 함수
    function log(message) {
      const now = new Date();
      const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
      const logEntry = document.createElement('div');
      logEntry.textContent = `${timestamp} - ${message}`;
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // 활성 사용자 목록 업데이트
    function updateActiveUsers() {
      if (activeUsers.size === 0) {
        activeUsersElement.innerHTML = '접속자: 없음';
        return;
      }
      
      let html = '접속자: ';
      activeUsers.forEach((user, id) => {
        html += `<span class="user-info" style="background-color: ${user.color}">${user.name}</span> `;
      });
      
      activeUsersElement.innerHTML = html;
    }
    
    // 바이트 배열을 문자열로 디코딩
    function decodeByteArray(byteArray) {
      return new TextDecoder().decode(new Uint8Array(byteArray));
    }
    
    // 연결 상태 업데이트
    function updateStatus(isConnected) {
      connected = isConnected;
      if (isConnected) {
        statusElement.textContent = '연결 상태: 연결됨';
        statusElement.className = 'status connected';
        editorElement.disabled = false;
      } else {
        statusElement.textContent = '연결 상태: 연결 안됨';
        statusElement.className = 'status disconnected';
        editorElement.disabled = true;
        activeUsers.clear();
        updateActiveUsers();
      }
      connectBtn.disabled = isConnected;
      disconnectBtn.disabled = !isConnected;
    }
    
    // 연결 버튼 클릭
    connectBtn.addEventListener('click', () => {
      if (connected) return;
      
      const docId = docIdInput.value.trim();
      const username = usernameInput.value.trim() || '익명';
      const userColor = userColorSelect.value;
      
      if (!docId) {
        alert('문서 ID를 입력하세요');
        return;
      }
      
      try {
        // WebSocket 서버에 연결
        const wsUrl = `ws://${window.location.hostname}:8080/ws/document/${docId}`;
        log(`WebSocket 연결 시도: ${wsUrl}`);
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          log('WebSocket 연결 성공');
          updateStatus(true);
          
          // 현재 사용자 추가
          const userId = `${username}-${Date.now().toString(36)}`;
          activeUsers.set(userId, {name: username, color: userColor});
          updateActiveUsers();
          
          // 사용자 정보 메시지
          const userInfoMessage = {
            type: 'user_info',
            docId: docId,
            userId: userId,
            name: username,
            color: userColor
          };
          ws.send(JSON.stringify(userInfoMessage));
          
          // 초기 메시지 전송
          const initialMessage = {
            type: 'sync',
            docId: docId,
            update: Array.from(new TextEncoder().encode(editorElement.value || '')),
            origin: userId
          };
          ws.send(JSON.stringify(initialMessage));
        };
        
        ws.onmessage = (event) => {
          try {
            const data = event.data;
            
            // 텍스트 메시지 처리
            if (typeof data === 'string') {
              const message = JSON.parse(data);
              log(`메시지 수신: type=${message.type}, origin=${message.origin || '알 수 없음'}`);
              
              if (message.type === 'sync') {
                // 다른 클라이언트에서 온 메시지만 처리
                const currentUserId = Array.from(activeUsers.keys())[0]; // 현재 사용자 ID
                
                if (message.origin !== currentUserId) {
                  log(`다른 사용자의 업데이트 적용`);
                  
                  // 현재 커서 위치 저장
                  lastCursorPosition = editorElement.selectionStart;
                  
                  // 로컬 업데이트 플래그 설정
                  isLocalUpdate = true;
                  
                  // 바이트 배열을 텍스트로 변환하여 에디터에 표시
                  const text = decodeByteArray(message.update);
                  editorElement.value = text;
                  
                  // 커서 위치 복원
                  try {
                    editorElement.setSelectionRange(lastCursorPosition, lastCursorPosition);
                  } catch (e) {
                    // 커서 위치가 범위를 벗어난 경우
                    editorElement.setSelectionRange(editorElement.value.length, editorElement.value.length);
                  }
                  
                  // 로컬 업데이트 플래그 해제
                  isLocalUpdate = false;
                }
              } else if (message.type === 'user_info') {
                // 사용자 정보 업데이트
                activeUsers.set(message.userId, {
                  name: message.name,
                  color: message.color
                });
                updateActiveUsers();
                log(`사용자 접속: ${message.name}`);
              }
            }
          } catch (error) {
            log(`메시지 처리 오류: ${error.message}`);
            console.error(error);
          }
        };
        
        ws.onclose = (event) => {
          log(`WebSocket 연결 종료: code=${event.code}, reason=${event.reason}`);
          updateStatus(false);
        };
        
        ws.onerror = (error) => {
          log('WebSocket 오류 발생');
          console.error(error);
        };
        
        // 텍스트 편집 이벤트
        editorElement.addEventListener('input', () => {
          if (!connected || !ws || isLocalUpdate) return;
          
          // 현재 커서 위치 저장
          lastCursorPosition = editorElement.selectionStart;
          
          // 현재 사용자 ID
          const currentUserId = Array.from(activeUsers.keys())[0];
          
          const message = {
            type: 'sync',
            docId: docId,
            update: Array.from(new TextEncoder().encode(editorElement.value)),
            origin: currentUserId
          };
          
          ws.send(JSON.stringify(message));
          log('텍스트 업데이트 전송');
        });
        
      } catch (error) {
        log(`초기화 오류: ${error.message}`);
        console.error(error);
      }
    });
    
    // 연결 해제 버튼 클릭
    disconnectBtn.addEventListener('click', () => {
      if (!connected || !ws) return;
      
      log('연결 해제 중...');
      ws.close();
      ws = null;
      editorElement.value = '';
      updateStatus(false);
    });
    
    // 페이지 언로드 시 정리
    window.addEventListener('beforeunload', () => {
      if (ws) {
        ws.close();
        ws = null;
      }
    });
    
    // 로그 시작
    log('페이지 로드됨. 연결 버튼을 눌러 시작하세요.');
  </script>
</body>
</html>
